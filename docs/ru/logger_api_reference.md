# Simple Logger API Reference

Документ описывает доступные HTTP-эндпоинты Simple Logger. API реализовано поверх Express и предполагает JSON-запросы и ответы.

## Базовые сведения

- Базовый URL: `http://<host>:<port>/api`
- Формат данных: `application/json`
- Аутентификация: заголовок `Authorization: Bearer <token>` (для административных эндпоинтов)
- Часовой пояс дат: ISO 8601 в UTC

## 1. Авторизация

### POST `/auth/login`

Авторизует администратора по логину и паролю. После успешного входа возвращает токен, который требуется передавать в административных запросах.

#### Тело запроса
```json
{
  "username": "admin",
  "password": "secret"
}
```

#### Успешный ответ `200 OK`
```json
{
  "token": "<jwt-like-token>"
}
```

#### Возможные ошибки
- `401 Unauthorized` — неверная пара логин/пароль
- `423 Locked` — IP временно заблокирован после множества неудачных попыток

## 2. Управление проектами

### POST `/projects`

Создаёт новый проект логирования. Требует административного токена.

#### Заголовки
`Authorization: Bearer <token>`

#### Тело запроса
```json
{
  "name": "Orders Service",
  "description": "Handles order events",
  "logFormat": {"level": "string", "message": "string"},
  "defaultTags": ["DEBUG", "INFO", "WARNING", "ERROR", "CRITICAL"],
  "customTags": ["PAYMENT"],
  "accessLevel": "global",
  "telegramNotify": {
    "enabled": true,
    "recipients": [{"chatId": "123456", "tags": ["ERROR", "CRITICAL"]}],
    "antiSpamInterval": 30
  },
  "debugMode": false
}
```

#### Ответ `201 Created`
JSON-объект проекта с автоматически выданным `uuid`.

#### Ошибки
- `400 Bad Request` — некорректные поля, описание ошибки в `details`

### GET `/projects`

Возвращает все проекты (последние вверху). Требует токен.

#### Ответ `200 OK`
Массив объектов проекта.

### GET `/projects/{uuid}`

Возвращает один проект по UUID. Требует токен.

#### Ответ `200 OK`
JSON-объект проекта.

#### Ошибки
- `404 Not Found` — проект отсутствует

### PUT `/projects/{uuid}`

Обновляет существующий проект. UUID менять нельзя.

#### Тело запроса
Совпадает по структуре с POST `/projects`.

#### Ответ `200 OK`
Обновлённый объект проекта. Поле `uuid` всегда совпадает с исходным значением.

#### Ошибки
- `400 Bad Request` — некорректные поля или попытка изменить UUID
- `404 Not Found` — проект отсутствует

### DELETE `/projects/{uuid}`

Удаляет проект вместе с логами и ping-сервисами. Системный проект `logger-system` удалить нельзя.

#### Ответ `200 OK`
```json
{
  "message": "Проект удален",
  "deletedLogs": 120,
  "deletedPingServices": 3
}
```

Поля `deletedLogs` и `deletedPingServices` отражают количество очищенных записей и помогают убедиться, что связанные данные удалены полностью.

#### Ошибки
- `400 Bad Request` — попытка удалить системный проект
- `404 Not Found` — проект отсутствует

### GET `/projects/{uuid}/logs`

Возвращает до 5000 логов для проекта с применением фильтров. Требует токен.

#### Параметры запроса
- `level` — уровень лога
- `text` — поиск по сообщению
- `tag` — фильтрация по тегу
- `user`, `ip`, `service` — фильтрация по метаданным
- `startDate`, `endDate` — временной диапазон в ISO 8601

#### Ответ `200 OK`
```json
{
  "project": { "uuid": "...", "name": "...", ... },
  "logs": [ { "level": "INFO", "message": "...", ... } ]
}
```

#### Ошибки
- `400 Bad Request` — не указан `uuid`
- `404 Not Found` — проект не найден

### POST `/projects/{uuid}/ping-services`

Регистрирует новый ping-сервис для мониторинга доступности. Требует токен.

#### Тело запроса
```json
{
  "name": "Billing health-check",
  "url": "https://billing.example.com/health",
  "interval": 60,
  "telegramTags": ["PING_DOWN"]
}
```

#### Ответ `201 Created`
Созданная запись ping-сервиса.

### GET `/projects/{uuid}/ping-services`

Возвращает список ping-сервисов проекта. Требует токен.

### POST `/projects/{uuid}/ping-services/check`

Принудительно запускает проверку всех ping-сервисов проекта и возвращает обновлённые записи. Требует токен.

## 3. Работа с логами

### POST `/logs`

Принимает логи от приложений. Не требует токена, но проверяет существование проекта по UUID.

#### Тело запроса
```json
{
  "uuid": "<project-uuid>",
  "log": {
    "level": "ERROR",
    "message": "Ошибка оплаты",
    "tags": ["PAYMENT"],
    "timestamp": "2024-05-20T10:00:00.000Z",
    "metadata": {
      "ip": "10.0.0.5",
      "service": "billing",
      "user": "user-1",
      "extra": {"orderId": "A-42"}
    }
  }
}
```

#### Ответ `201 Created`
Сохранённая запись лога.

#### Ошибки
- `400 Bad Request` — тело не соответствует схеме (если UUID корректный, событие записывается в системный проект `logger-system`)
- `404 Not Found` — проект с указанным UUID отсутствует (лог также записывается в системный проект `logger-system`)

При этом системный лог содержит информацию о проблеме и UUID проекта, например:

```json
{
  "level": "WARNING",
  "tags": ["INGEST", "VALIDATION"],
  "message": "Получен лог неверного формата для проекта 9f...",
  "metadata": {
    "service": "log-ingest",
    "extra": {
      "projectUuid": "9f...",
      "issues": "log.message: Required"
    }
  }
}
```

### GET `/logs`

Фильтрация логов по всем проектам. Требует токен.

#### Параметры запроса
- `uuid` — обязательный UUID проекта
- `level`, `text`, `tag`, `user`, `ip`, `service`, `startDate`, `endDate`

#### Ответ `200 OK`
```json
{
  "project": { ... },
  "logs": [ ... ]
}
```

### DELETE `/logs/{uuid}`

Удаляет логи проекта по фильтру. Требует токен.

#### Параметры запроса
Аналогичны GET `/logs`.

#### Ответ `200 OK`
```json
{ "deleted": 42 }
```

#### Ошибки
- `404 Not Found` — проект отсутствует

## 4. Белый список IP

Все операции требуют административного токена.

### GET `/settings/whitelist`

Возвращает массив IP-адресов с описанием.

### POST `/settings/whitelist`

Добавляет или обновляет запись. Принимает JSON:
```json
{
  "ip": "192.168.0.10",
  "description": "VPN gateway"
}
```

Ответ `201 Created` содержит актуальную запись.

### DELETE `/settings/whitelist/{ip}`

Удаляет IP-адрес. Ответ `200 OK`:
```json
{ "success": true }
```

#### Ошибки
- `404 Not Found` — запись отсутствует

## 5. Ответы об ошибках

Большинство ошибок возвращаются в формате:
```json
{
  "message": "Описание ошибки",
  "details": { ... } // опционально
}
```

Используйте HTTP-статус для определения класса проблемы.

## 6. Рекомендации по использованию

- Перед отправкой административных запросов всегда выполняйте авторизацию и сохраняйте токен.
- Для интеграции приложений предпочтительно использовать UUID проекта и метод `POST /logs`.
- Ping-сервисы помогают контролировать доступность внешних систем; включайте уведомления Telegram для критических сервисов.
- Белый список IP полезен при использовании режима доступа `whitelist` в проекте.
