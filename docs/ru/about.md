## Детализация требований Logger — сервис логирования для микросервисной архитектуры

***

### 1. Цели проекта

**Logger** — сервис централизованного безопасного сбора, анализа и мониторинга логов микросервисов с гибкими настройками, IP-фильтрацией, интеграцией с telegram и функционалом технического мониторинга по http.

***

### 2. Бизнес-требования

- Простое подключение всех микросервисов через API и web-интерфейс
- Уведомление об инцидентах через telegram
- Мониторинг состояния проектов с помощью ping-запросов
- Защита от несанкционированного доступа и спама (basic anti-DDOS, whitelist IP)
- Гибкая фильтрация, выгрузка и очистка логов

***

### 3. Функциональные требования

#### 3.1. Веб-интерфейс (страницы)

- **Авторизация** — страница входа (логин/пароль, IP-блокировка на час после 5 ошибочных попыток)
- **Дашборд** — сводная панель состояния проектов, отображение инцидентов, быстрый переход к основным разделам. 
- **Панель проектов** — список проектов для логирования с переходом в карточку проекта.
- **Панель сервисов** — список сервисов, отслеживаемых ping-метриками (отдельно для каждого проекта).
- **Просмотр логов** — фильтрация логов (дата/время, уровень, текст, теги, пользователь/сессия, IP, сервис).
- **Добавить проект** — создать новый проект для логирования, задать JSON-формат лога, пользовательские теги, telegram-уведомления.
- **Добавить сервис мониторинга** — добавить сервис для ping-отслеживания, настроить URL, интервал, telegram-уведомления.
- **Управление telegram-ботом** — подключение бота, редактирование списка пользователей для оповещения.
- **Настройки** — системные параметры проекта, white list IP, анти-DDOS, просмотр системных логов.

***

#### 3.2. База данных (MongoDB)

Каждый проект хранит:
- `uuid` — уникальный идентификатор
- `name` — название сервиса/микросервиса
- `description` — описание
- `logFormat` — json-формат лога
- `defaultTags` — стандартные теги (DEBUG, INFO, WARNING, ERROR, CRITICAL)
- `customTags` — дополнительные проектные теги (например, SMS, EMAIL)
- `accessLevel` — глобальный, whitelist, только внутри docker
- `telegramNotify` — список пользователей, условия уведомления, анти-спам, количество повторов, теги для уведомлений
- `debugMode` — режим отладки (оповещения в telegram не отправляются)
- Системные сущности: проекты, пользователи telegram, белый список IP, логи, настройки anti-DDOS

***

#### 3.3. API

- Получение логов для проекта — формат JSON: `{"uuid": "...", "log": {...}}`
- Создание/редактирование проекта, добавление сервисов пинга
- Получение состояния ping-сервисов, настройка периодичности и URL
- Фильтрация, выгрузка логов за выбранный период и условия
- Добавление, удаление IP из whitelist, настройка анти-DDOS

***

#### 3.4. Безопасность

- Проверка на наличие системного проекта logger, восстановление если удалён
- Все попытки входа в web-интерфейс (успешные и неудачные) пишутся с IP и метками
- Неверный UUID логируется как инцидент безопасности
- Базовая защита: rate limiting, белый список IP (ручное добавление через UI)
- Доступ внутри docker по умолчанию открыт

***

#### 3.5. Интеграция с telegram

- Telegram-бот подключается через BOT_API_KEY
- Список пользователей для уведомлений — можно изменить через web
- Условия уведомлений — теги логов, статус ping, анти-спам (оповещать только один раз/с интервалом)

***

#### 3.6. Работа с логами

- Мощные фильтры: дата, уровень, сообщение, тег, сессия/пользователь, IP, имя сервиса
- Выгрузка отфильтрованных логов в текстовый файл
- Очистка по фильтру или полное удаление выбранных логов
- Отображение количества и размера логов для проекта

***

#### 3.7. Документация

- Принцип работы логера (описать концепцию, архитектуру, маршруты и пользовательские сценарии)
- Архитектура приложения: схема директорий (.devcontainer, docs, mongodata, src, test, docker-compose.dev.yml, docker-compose.prod.yml)
- Структура БД на уровне коллекций и ключей
- Примеры использования API для отправки логов, добавления проектов, выдачи фильтрации
- JSdoc для всех файлов и сущностей, комментарии на русском языке

***

### 4. Архитектурная схема и структура проекта

```plaintext
/logger-project
├── .devcontainer/
├── docs/
├── mongodata/
├── src/
│   ├── api/
│   │   ├── routes/
│   │   ├── controllers/
│   │   ├── models/
│   │   ├── utils/
│   │   └── middlewares/
│   ├── telegram/
│   ├── ping/
│   └── app.ts
├── test/
│   └── ...
├── docker-compose.dev.yml
├── docker-compose.prod.yml
```

***

### 5. Псевдографический прототип интерфейса

#### Главная страница (dashboard)

```
+-----------------------------------------------------+
| Logger - Панель управления                          |
+-------------------+---------------------------------+
| [Меню]            | [Общий статус проектов]         |
|                   | [Список сервисов/проектов]      |
| - Проекты         |                                 |
| - Логи            |                                 |
| - Ping-мониторинг |                                 |
| - Telegram        |                                 |
| - Настройки       |                                 |
+-------------------+---------------------------------+
```

***

### 6. SMART-постановка задач для разработки

- Реализовать хранилище проектов по схеме выше 
- Реализовать фильтрацию логов по всем параметрам
- Web-интерфейс для управления бэкапом и выгрузками 
- Интеграция telegram-бота: отправка, настройка, анти-спам 
- Полностью покрыть API тестами (Jest)
- Оформить JSdoc на всех сущностях

***

### 7. Блоки для специалистов

- Backend (NodeJS, Express, TypeScript, MongoDB): архитектура, API, безопасность, работа с логами, интеграция telegram
- Frontend (React, TypeScript): web-интерфейс, фильтрация, UX
- DevOps: docker-compose, настройка окружения, backup mongodata
- Аналитик/Документация: оформление docs, примеры работы, описание структуры

***

## Прототипы интерфейса Logger: описание всех страниц и логика работы


***

### Общие принципы

- Все страницы отображаются только на русском языке.
- Доступ к web-интерфейсу разрешён только с IP-адресов, указанных в переменной окружения или добавленных в белый список; настройки внутри Docker игнорируются.
- Логика переходов — централизованное левое (или верхнее) меню, быстрая навигация между основными разделами.
- Для каждой страницы описан базовый внешний вид, интерактивные элементы, состояния, логика работы и необходимые действия пользователя.

***

### 1. Страница авторизации

**Описание:**

- Форма входа — только логин/пароль, значения берутся из переменных окружения.
- После 5 неверных попыток — запросы с текущего IP блокируются на 1 час.
- Все успешные и неудачные попытки логируются.

**Псевдографика:**

```
+-----------------------------------+
|    Авторизация Logger             |
|-----------------------------------|
| Логин: [___________]              |
| Пароль: [___________]             |
|                                   |
| [ Войти ]                         |
|                                   |
| Сообщение об ошибке               |
+-----------------------------------+
```

**Логика:**

- После успешного входа — переход на dashboard.
- После блокировки IP — объяснение причины и ожидание.
- После выхода — браузер очищает сессию.

***

### 2. Дашборд — Главная панель

**Описание:**

- Сводная информация по состоянию всех проектов и сервисов.
- Краткая статистика: количество проектов, сервисов, логов, ошибок, предупреждений.
- Виджет с недавними инцидентами, событиями и состоянием ping-проектов.

**Псевдографика:**

```
+-----------------------------------------------+
| Logger: Панель управления                     |
+----------+------------------------------------+
| [Меню]   |  Проекты: 5                       |
|          |  Активно: 4                        |
|          |  Ошибки: 1 (Telegram отправлен)    |
+----------+------------------------------------+
| [Сервисы]           | [Инциденты]             |
| Project#1: OK       | [09:18] Ошибка ping     |
| Project#2: WARNING  | [08:35] ERROR лог       |
| ...                 |                         |
+-----------------------------------------------+
```

**Логика:**

- Переход к подробному списку проектов, сервисов, логов.
- В реальном времени обновление состояния по WebSocket или периодическим polling.

***

### 3. Панель проектов (Список проектов)

**Описание:**

- Cписок всех проектов с краткой инфой: имя, UUID, теги, уровень доступа, состояние.
- Кнопки: просмотр, редактирование, удаление, выгрузка логов, добавить проект.

**Псевдографика:**

```
+---------------------------------------------------------------+
| [Добавить проект]                                             |
+---------------------------------------------------------------+
| | Имя         | UUID     | Теги  | Доступ    | Статус    | ▼ |
| |-------------|----------|-------|-----------|-----------|---|
| | users-svc   | ...3d... | SMS   | whitelist | OK        | О |
| | pay-svc     | ...a2... | EMAIL | global    | WARNING   | О |
| | logger      | ...z1... | CRITICAL | docker | OK        | О |
+---------------------------------------------------------------+
```

**Логика:**

- Фильтрация по имени, UUID, тегу, доступу.
- Клик по проекту — переход в карточку проекта (страница подробного лога).

***

### 4. Добавление проекта

**Описание:**

- Форма для создания нового проекта: название, описание, UUID (автоназначение), JSON-формат лога, пользовательские теги, уровень доступа, telegram-уведомления, debug-режим.

**Псевдографика:**

```
+-----------------------------------+
| Новый проект                      |
|-----------------------------------|
| Название: [____________]          |
| Описание: [____________]          |
| Формат логов (JSON): { ... }      |
| Теги: [DEBUG, INFO, ...]          |
| Доступ: ( ) global ( ) whitelist  |
| Telegram-уведомления: [настроить] |
| Debug-режим: [☑]                  |
|                                   |
| [ Создать ]                       |
+-----------------------------------+
```

**Логика:**

- Проверка корректности формата логов.
- Создание проекта и автоматическая генерация UUID.

***

### 5. Панель сервисов мониторинга (ping)

**Описание:**

- Список сервисов для мониторинга с параметрами: имя, проект, URL, периодичность, последний статус, telegram-уведомления.
- Кнопки: добавить, редактировать, удалить, включить/выключить мониторинг.

**Псевдографика:**

```
+--------------------------------------------------------+
| [Добавить сервис]                                      |
+--------------------------------------------------------+
| Проект     | URL           | Период   | Cтатус | ▼     |
|------------|---------------|----------|--------|-------|
| users-svc  | api/users     | 5 мин    | OK     | О     |
| pay-svc    | api/payments  | 10 мин   | ERROR  | О     |
+--------------------------------------------------------+
```

**Логика:**

- Поддержка настройки URL и поиска элемента (HTML, JSON, статус код).
- Настройка telegram-уведомлений для каждого сервиса.

***

### 6. Просмотр логов и управление логами

**Описание:**

- Список логов проекта: дата, время, сообщение, уровень, теги, пользователь, IP, имя сервиса.
- Фильтрация по всем параметрам (интерфейс с dropdown и поиском).
- Кнопки: выгрузить логи (текущий фильтр), удалить выбранные, очистить проект.

**Псевдографика:**

```
+--------------------------------------------------------------------------------------+
| Проект: users-svc                                                                    |
+--------------------------------------------------------------------------------------+
| Фильтры: [ Дата ] [ Уровень ] [ Тег ] [ IP ] [ Сервис ] [ Содержимое ] [ Найти ]     |
+--------------------------------------------------------------------------------------+
| Дата       | Уровень   | Сообщение       | Теги   | Пользователь | IP     | ...      |
|------------|-----------|-----------------|--------|--------------|--------|----------|
| 23.09. 10:02 | ERROR   | Ошибка pay API  | payment| 123123       | ...    |          |
| ...        | ...       | ...             | ...    | ...          | ...    |          |
+--------------------------------------------------------------------------------------+
| [Выгрузить] [Удалить выбранные] [Очистить]                                           |
| Размер логов: 5МБ   | Количество: 1222                                              |
+--------------------------------------------------------------------------------------+
```

**Логика:**

- Все фильтры применяются на сервере.
- Кнопка выгрузки — сохранение .txt в выбранном формате.
- Кнопка очистки — подтверждение через диалог.

***

### 7. Страница управления telegram-ботом и списком пользователей

**Описание:**

- Поключение/отключение бота (BOT_API_KEY).
- Список пользователей (TELEGRAM_USER_ID), добавить/удалить, выбор условий для отправки уведомлений (по тегам, по типу инцидента).
- Настройка анти-спама: количество повторов, интервал между отправкой в чат.

**Псевдографика:**

```
+------------------------------------------------+
| Telegram-бот                                   |
|------------------------------------------------|
| API-KEY: [_________] (Подключить/Отключить)    |
|------------------------------------------------|
| Пользователи для оповещения:                   |
| ID         | Имя       | Теги     | Оповещения |
|------------|-----------|----------|------------|
| 33434      | Иван      | ERROR    | 1 раз      |
| 94423      | Мария     | WARNING  | раз в час  |
+------------------------------------------------+
| [Добавить пользователя] [Удалить] [Настроить]  |
+------------------------------------------------+
```

**Логика:**

- Подключение/замена бота через API KEY.
- Для каждого пользователя — выбор тегов и типа уведомления.

***

### 8. Страница настроек (системные, безопасность, whitelist)

**Описание:**

- Новый IP белого списка (ручное добавление/удаление).
- Настройки анти-DDOS: ограничение количества попыток, лимит запросов/сек.
- Просмотр системных логов Logger (отдельный проект).
- Показать конфигурацию окружения (только чтение).

**Псевдографика:**

```
+-------------------------------------------+
| Настройки Logger                          |
|-------------------------------------------|
| Белый список IP: [ 127.0.0.1, ... ]       |
|  [Добавить IP] [Удалить IP]               |
|-------------------------------------------|
| Anti-DDOS:                                |
| Лимит попыток: [ 100 ] в минуту           |
| Rate limiting: [ 20 ]/сек                 |
|-------------------------------------------|
| Системные логи:                           |
| [Посмотреть]                              |
|-------------------------------------------|
| Конфигурация окружения (read-only)        |
| MONGO_URI: ...                            |
| ...                                       |
+-------------------------------------------+
```

**Логика:**

- Изменение белого списка — только вручную.
- Anti-DDOS — параметры сохраняются в настройках проекта.
- Просмотр системных логов — фильтры аналогичны логам проектов.

***

### 9. Сценарии и состояния интерфейса

- Все формы проверки: валидация согласно типам (IP, telegram ID, JSON, текст, интервалы).
- Подтверждение опасных действий (очистить логи, удалить сервис, сбросить настройки).
- Ошибки — всплывающие уведомления в интерфейсе.
- Страница "404"/"Нет доступа" — если зашел не с разрешённого IP.
- Разделение ролей — только администратор.

***

## Пример wireframe в JSON для генератора макетов

```json
[
  {
    "page": "login",
    "blocks": [
      { "type": "form", "fields": ["login", "password"] },
      { "type": "button", "label": "Войти" },
      { "type": "error_message" }
    ]
  },
  {
    "page": "dashboard",
    "blocks": [
      { "type": "stats", "items": ["projects", "services", "errors", "warnings"] },
      { "type": "list", "name": "incidentList" },
      { "type": "menu", "items": ["Проекты", "Логи", "Ping", "Telegram", "Настройки"] }
    ]
  },
  {
    "page": "projects",
    "blocks": [
      { "type": "data_table", "columns": ["Имя", "UUID", "Теги", "Доступ", "Статус"] },
      { "type": "button", "label": "Добавить проект" }
    ]
  },
  {
    "page": "add_project",
    "blocks": [
      { "type": "form", "fields": ["name", "description", "logFormat", "tags", "access", "telegramNotify", "debugMode"] },
      { "type": "button", "label": "Создать" }
    ]
  },
  {
    "page": "services",
    "blocks": [
      { "type": "data_table", "columns": ["Проект", "URL", "Период", "Статус"] },
      { "type": "button", "label": "Добавить сервис" }
    ]
  },
  {
    "page": "logs",
    "blocks": [
      { "type": "filters", "fields": ["date", "level", "tag", "ip", "service", "message"] },
      { "type": "data_table", "columns": ["Дата", "Уровень", "Сообщение", "Теги", "Пользователь", "IP"] },
      { "type": "buttons", "items": ["Выгрузить", "Удалить выбранные", "Очистить"] }
    ]
  },
  {
    "page": "telegram",
    "blocks": [
      { "type": "form", "fields": ["apiKey"] },
      { "type": "data_table", "columns": ["ID", "Имя", "Теги", "Оповещения"] },
      { "type": "buttons", "items": ["Добавить пользователя", "Удалить"] }
    ]
  },
  {
    "page": "settings",
    "blocks": [
      { "type": "list", "name": "whitelist", "fields": ["ip"] },
      { "type": "form", "fields": ["ddosLimit", "rateLimit"] },
      { "type": "button", "label": "Посмотреть системные логи" },
      { "type": "static", "fields": ["config"] }
    ]
  }
]
```


***

