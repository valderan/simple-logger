# Предлагаемые улучшения безопасности API

Ниже перечислены доработки, которые сделают систему безопасности Simple Logger более гибкой и удобной. Предложения базируются на анализе текущего кода из каталога `./api`.

## 1. Управление блокировками входа

- **Вынести хранение попыток входа из памяти**. Сейчас `LoginAttempts` опирается на in-memory `Map`, поэтому блокировки пропадают после рестарта и недоступны для аудита.【F:api/src/api/utils/loginAttempts.ts†L11-L38】 Предлагается хранить попытки во встроенной коллекции MongoDB или Redis, что позволит анализировать подозрительные активности.
- **Добавить административный API для сброса блокировки**. При ошибочном вводе пароля пользователю приходится ждать тайм-аут либо перезапускать контейнер.【F:api/src/api/controllers/authController.ts†L15-L22】 Стоит реализовать защищённый эндпоинт/CLI, который очищает счётчик по IP или пользователю.
- **Логирование критических событий**. Сейчас блокировки не записываются в `logger-system`. Добавление вызова `writeSystemLog` упростит расследование инцидентов.【F:api/src/api/utils/systemLogger.ts†L9-L19】

## 2. Гибкий контроль allowlist

- **Оперативное обновление кэша белого списка**. Middleware `ipWhitelist` обновляет кэш раз в минуту.【F:api/src/api/middlewares/ipWhitelist.ts†L4-L37】 Стоит добавить ручной инвалидационный хук (например, при изменении записи) или подписку на change stream MongoDB, чтобы новые IP применялись мгновенно.
- **Отчётность по заблокированным IP**. Предлагается вести журнал отказов (с IP, путём и заголовками), возможно, в отдельной коллекции. Это позволит оперативно понимать, кого блокирует allowlist.
- **Механизм временного доступа**. Добавить поддержку записей с TTL, чтобы можно было разрешить IP на ограниченный период без ручного удаления.

## 3. Пропускная способность и лимиты

- **Конфигурируемые лимиты для ingest**. Глобальный rate limiter ограничивает 120 запросов/минуту для всех маршрутов.【F:api/src/api/middlewares/rateLimiter.ts†L6-L11】 Для высоконагруженных проектов стоит выделить отдельный лимитер для `/api/logs` и разрешить настройку порогов через переменные окружения или параметры проекта.
- **Асинхронный приём логов**. Сейчас `LogModel.create` вызывается синхронно, что плохо масштабируется при больших нагрузках.【F:api/src/api/controllers/logController.ts†L62-L76】 Можно добавить очередь (Kafka, RabbitMQ, BullMQ) и воркеры для записи в БД.
- **Массовая проверка UUID**. Неверные UUID фиксируются, но не блокируются автоматически.【F:api/src/api/controllers/logController.ts†L52-L59】 Имеет смысл добавить порог на число ошибок от одного IP/проекта и временно ограничивать приём, чтобы защититься от ошибочных интеграций.

## 4. Улучшение уведомлений и наблюдаемости

- **Мониторинг отправок Telegram**. Расширить `TelegramNotifier`, чтобы он писал успешные и неудачные доставки в системные логи и поддерживал ограничение по общему числу сообщений за интервал.【F:api/src/telegram/notifier.ts†L20-L37】
- **API для просмотра состояния очередей уведомлений**. Сейчас анти-спам хранится в памяти. Стоит добавить эндпоинт, позволяющий увидеть, когда будет отправлено следующее сообщение конкретному получателю.

## 5. Улучшение инфраструктурных настроек

- **Переключаемый CORS/helmet**. Текущая конфигурация использует значения по умолчанию.【F:api/src/app.ts†L17-L23】 Стоит вынести список разрешённых Origin и дополнительные заголовки в конфигурацию.
- **Разделение токенов по ролям**. Сейчас только один администратор с парой `ADMIN_USER`/`ADMIN_PASS`. Добавление ролей и персональных токенов позволило бы разграничить доступ (только чтение логов, управление whitelist и т. д.).

Реализация этих улучшений повысит прозрачность безопасности и упростит эксплуатацию сервиса в командах с разными требованиями.

